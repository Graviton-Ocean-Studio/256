<!DOCTYPE html>
<html>
<head>
<script>var CUSTOM="CUSTOM",games=[["Dbd","dbcAbd","Ici"],["Fc---f","aaaaaaaaAdp","Hcd-d"],["Hcc-e","Pdp",CUSTOM]];</script>
<script id="hints" language="text/x-hint">[
["Hi there! Good choice for you! Click some cute empty space to put a 2 there, and then use wasd, the arrow keys, or swipe to move the tiles. Just like 2048, but try your best to get the target numbers, for instance, 16!",
 "Hi! Now try this.",
 "Here... is a more advanced one."],
["Similar to the last one, isn't it?",
 "This one is... Kind of interesting.",
 "This goes much harder."],
["Similar to the last one, isn't it?",
 "This one is <span style=\"font-weight:bold;color:red;\">TERRIBLY TIME-CONSUMING</span>. Original 2048 grid, but force you to get 65536.",
 "TBD"]
]</script>
<title>256</title>
<link rel="manifest" href="256.webmanifest">
<meta http-equiv="Content-Type" content="text/html;charset=utf-8">
<meta name="viewport" content="width=320">
<style>
html{
	height:100%;
	background:#f5fafd;
	color:#002d4d;
	font-family:Consolas, Monaco, monospace;
}
body{
	display:table;
	height:100%;
	width:100%;
	margin:0;
}
.padding{
	display:table-row;
	height:auto;
}
#wrapper-out{
	display:table-row;
	text-align:center;
	width:100%;
	height:258px;
}
#wrapper-mid{
	display:inline-block;
	width:258px;
	height:258px;
	border:1px solid #002d4d;
}
#wrapper-in{
	display:table;
	height:100%;
	width:100%;
	position:relative;
}
.tile-wrapper{
	height:0;
	width:0;
	margin:0;
}
.row{
	display:table-row;
	height:auto;
}
.empty{
	display:table-cell;
	width:auto;
	border:1px solid #002d4d;
}
.tile{
	position:relative;
	display:block;
	font-size:40px;
	transition:all 0.5s ease;
}
#hint{
	position:fixed;
	bottom:-5px;
	background:#002d4d;
	color:#f5fafd;
	padding:5px;
	padding-bottom:10px;
	right:10px;
	left:10px;
	border-radius:4px;
	text-align:center;
}
#controls{
	position:fixed;
	top:0;
}
</style>
</head>
<body>
<span id="controls">
<button onclick="localStorage[GAMEKEY]='';location.reload();">Clear and replay</button>
<span id="status"></span>
</span>
<div class="padding"></div>
<div id="wrapper-out">
<div id="wrapper-mid">
<div id="wrapper"></div>
<div id="wrapper-in">

</div>
</div>
</div>
<div class="padding"></div>
<div id="hint"></div>

<script type="text/javascript">
var GAMEKEY="game_256_main";
var TOUCH_THRESHOLD=32;
var $=function(sel){
	return (
		sel.startsWith("#")
		?document.querySelector(sel)
		:document.querySelectorAll(sel));
};
var isUpper=function(str,pos){
	if(!pos)pos=0;
	var code=str.charCodeAt(pos);
	if(code>90)return false;
	if(code<65)return false;
	return code-64;
}
var isLower=function(str,pos){
	if(!pos)pos=0;
	var code=str.charCodeAt(pos);
	if(code>122)return false;
	if(code<97)return false;
	return code-96;
}
var emptyWrap=$("#wrapper-in");
var wrap=$("#wrapper");
var statusBox=$("#status");
var hint=$("#hint");
var BLACK="#002d4d",WHITE="#f5fafd";
//FIXME replace this with real game
var gameEncoded="Hcd-d";

//TODO documentation
//@function getset
function getset(_get,_set){ //add _ to avoid using keywords
	return function GetSet(){
		if(arguments.length==0)return _get();
		else return _set.apply(null,arguments);
	}
}

//@Class Tile
//@constructor public
//@param value {Number} log2(tile value) || Tile.BLOCK
var Tile=function(value){
	this.value=value;
};
Tile.BLOCK=-1;
Tile.prototype.render=function(x,y,size){
	if(!this.el){
		this.el=document.createElement("span");
		var parent=this.parent=document.createElement("div");
		parent.className="tile-wrapper";
		parent.appendChild(this.el);
	}
	var el=this.el;
	el.className="tile";
	el.style.top=y*size+1+"px";
	el.style.left=x*size+1+"px";
	el.style.width=el.style.height=el.style.lineHeight=size+"px";
	el.innerText=this.value==-1?" ":Math.pow(2,this.value);
	//TODO: color
	if(this.value==Tile.BLOCK){
		el.style.backgroundColor=BLACK;
		el.style.color=WHITE;
	}
	return this.parent;
}
Tile.prototype.fadeout=function(){
	this.el.style.opacity=0;
	var el=this.el.parentNode;
	el.parentNode?setTimeout(function(){
		el.parentNode.removeChild(el);
	},1000):0;
};

//@Class Game
//@constructor private
//used by Game.fromString
var Game=function(targets,map){
	if(!targets||!map){
		throw new TypeError("Bad Argument");
	}
	this.targets=targets;
	this.map=map;
};
//@function Game.fromString
//@description load a game from a game string (deserialization)
//@example Game.fromString("Hcd-d");
Game.fromString=function(str){
	var pos=0;
	
	//parse the targets
	var targetDone=false;
	var targets=[];
	while(!targetDone){
		var num=isUpper(str,pos);
		if(num) targetDone=true;
		else if (!(num=isLower(str,pos))) throw new TypeError("Target not an alphabet");
		targets.push(num);
		pos++;
	}
	
	//parse size
	var size=isLower(str,pos);
	if(!size) throw new TypeError("Size not lowercase alphabet");
	pos++;
	
	//generate empty map
	var map=[];
	for(var i=0;i<size;i++){
		map[i]=[];
		for(var j=0;j<size;j++) map[i].push(null);
	}
	
	//load map
	//TODO load numbers
	var mapstr=str.substr(pos);
	var coord=[0,0];//[x,y]
	for(pos=0;pos<mapstr.length;pos++){
		//TODO
		var spaces=isLower(mapstr,pos);
		if(spaces){ //lowercase is spaces
			coord[0]+=spaces;
		}else{ //not spaces
			switch(mapstr.substr(pos,1)){ //which command?
				case "-":
				map[coord[1]][coord[0]]=new Tile(Tile.BLOCK); //map is stored like [y][x]
				coord[0]++;
				break;
				
				default:
				throw new TypeError("Unknown command "+mapstr.substr(pos,1));
				break;
			}
		}
		//correct the coords
		coord[1]+=parseInt(coord[0]/size); //increase y
		coord[0]=coord[0]%size; //make correct x
		if(coord[1]>=size&&coord[0]!=0){ //check if overflow
			throw new TypeError("size overflow");
		}
	}
	return new Game(targets,map);
}
//magic words 233
Game.LEFT="https://alan.liangcn.ml/";
Game.RIGHT="Author: Alan-Liang@KEEER";
Game.UP="Email: alan-liang@keeer.ga";
Game.DOWN="I LOVE RDFZ";
Game.prototype.virtual=Game.LEFT; //no virtual
//@function (private)
Game.prototype._real=function(x,y){
	var size=this.map.length;
	switch(this.virtual){
		case Game.UP:
		return [x,y];
		
		case Game.DOWN:
		return [size-x-1,y];
		
		case Game.LEFT:
		return [y,x];
		
		case Game.RIGHT:
		return [y,size-x-1];
		
		default:
		throw new Error("Virtual Direction illegal");
	}
}
//@function game.tile
//@param x {Number} x coord
//@param y {Number} y coord
//@return {Function} GetSet of the tile
Game.prototype.tile=function(x,y){
	var map=this.map;
	var real=this._real(x,y);
	var size=this.size;
	return getset(
		function(){
			return map[real[0]][real[1]];
		},
		function(tile){
			map[real[0]][real[1]]=tile;
			if(tile) tile.render(real[1],real[0],size||0);
			return tile;
		}
	);
}
Game.prototype.render=function(getListener){
	var WIDTH=256;
	var size=this.size=256/this.map.length;
	wrap.innerHTML="";
	var html="";
	for(var i=0;i<this.map.length;i++){
		html+="<div class=\"row\">";
		for(var j=0;j<this.map.length;j++){
			html+="<span class=\"empty\" coords=\"["+j+","+i+"]\"></span>";
			var tile=this.tile(i,j)();
			if(tile) wrap.appendChild(tile.render(i,j,size));
		}
		html+="</div>";
	}
	emptyWrap.innerHTML=html;
	statusBox.innerText=this.toString();
	var spaces=$(".empty");
	var ctx=this;
	for(var i=0;i<spaces.length;i++){
		(function(el){
			if(!getListener) el.addEventListener("click",function(){
				if(!ctx.clickable) return;
				pos=JSON.parse(el.getAttribute("coords"));
				if(ctx.tile.apply(ctx,pos)())return;
				var tile=new Tile(1);
				ctx.tile.apply(ctx,pos)(tile);
				wrap.appendChild(tile.render(pos[0],pos[1],size));
				ctx.clickable=false;
				if((!ctx.won)&&ctx.reachedTarget()){
					alert("You won! Great job!");
					ctx.won=true;
				}
				if(!ctx.movable()){
					alert("Game over! Refresh to restart the game.");
					ctx.over=true;
					localStorage[GAMEKEY]="";
				}
				statusBox.innerText=ctx.toString();
			});
			else el.addEventListener("click",getListener(el));
		})(spaces[i]);
	}
	window.onkeyup=function(e){
		//console.log(e.keyCode);
		switch(e.keyCode){
			case 87: //w
			case 38: //up
			if(ctx.move(Game.UP)) ctx.clickable=true;
			break;
			
			case 65: //a
			case 37: //left
			if(ctx.move(Game.LEFT)) ctx.clickable=true;
			break;
			
			case 83: //s
			case 40: //down
			if(ctx.move(Game.DOWN)) ctx.clickable=true;
			break;
			
			case 68: //d
			case 39: //right
			if(ctx.move(Game.RIGHT)) ctx.clickable=true;
			break;
			
			default:
		}
		if((!ctx.won)&&ctx.reachedTarget()){
			alert("You won! Great job!");
			ctx.won=true;
		}else{
			localStorage[GAMEKEY]=JSON.stringify(ctx);
		}
		statusBox.innerText=ctx.toString();
	};
	window.ontouchstart=function(e){
		var touch=e.changedTouches[0];
		window._pageX=touch.pageX;
		window._pageY=touch.pageY;
	};
	window.ontouchend=function(e){
		var touch=e.changedTouches[0];
		var dx=touch.pageX-window._pageX;
		var dy=touch.pageY-window._pageY;
		var absDx=Math.abs(dx);
		var absDy=Math.abs(dy);
		var direction;
		if(absDx>TOUCH_THRESHOLD&&absDy<TOUCH_THRESHOLD){//horizontal
			if(dx>0) direction=Game.RIGHT;
			else direction=Game.LEFT;
		}
		if(absDy>TOUCH_THRESHOLD&&absDx<TOUCH_THRESHOLD){//vertical
			if(dy>0) direction=Game.DOWN;
			else direction=Game.UP;
		}
		if(direction){
			if(ctx.move(direction)) ctx.clickable=true;
		}
		if((!ctx.won)&&ctx.reachedTarget()){
			alert("You won! Great job!");
			ctx.won=true;
		}else{
			localStorage[GAMEKEY]=JSON.stringify(ctx);
		}
		statusBox.innerText=ctx.toString();
	};
	window.ontouchmove=function(e){
		e.preventDefault();
	};
	localStorage[GAMEKEY]=JSON.stringify(ctx);
};
Game.prototype.move=function(direction){
	if(this.clickable)return false;
	this.virtual=direction;
	var size=this.map.length;
	var moved=false;
	for(var i=0;i<size;i++){
		var available=0;
		var lastTile,lastX;
		lastTile=lastX=null;
		for(var j=0;j<size;j++){
			var tile=this.tile(j,i)();
			if(tile==null) continue;
			if(tile.value==Tile.BLOCK){
				available=j+1;
				lastTile=lastX=null;
				continue;
			}
			if(lastTile&&(tile.value==lastTile.value)){
				tile.value++;
				moved=true;
				lastTile.fadeout();
				this.tile(lastX,i)(tile);
				this.tile(j,i)(null);
				lastTile=null;
			}else{
				lastTile=tile;
				if(available!=j){
					this.tile(j,i)(null);
					this.tile(available,i)(tile);
					moved=true;
				}
				lastX=available;
				available++;
			}
		}
	}
	this.virtual=Game.LEFT;
	return moved;
}
Game.prototype.clickable=true;
Game.prototype.targetString=function(){
	var targets="";
	for(var i=0;i<this.targets.length;i++){
		targets+=Math.pow(2,this.targets[i]);
		if(i!=(this.targets.length-1)) targets+=", ";
	}
	return targets;
};
Game.mapCopy=function(map){
	var newmap=[];
	for(var i=0;i<map.length;i++){
		newmap.push([]);
		for(var j=0;j<map[i].length;j++){
			var tile=map[i][j]?new Tile(map[i][j].value):null;
			tile?tile.render():0;
			newmap[i].push(tile);
		}
	}
	return newmap;
};
Game.prototype.movable=function(){
	var newgame=new Game(this.targets, Game.mapCopy(this.map));
	newgame.clickable=false;
	if(newgame.move(Game.UP)||newgame.move(Game.DOWN)||newgame.move(Game.LEFT)||newgame.move(Game.RIGHT))
		return true;
	return false;
};
Game.prototype.reachedTarget=function(){
	var timesLeft={};
	for(var i=0;i<this.targets.length;i++){
		if(!timesLeft[this.targets[i]]) timesLeft[this.targets[i]]=0;
		timesLeft[this.targets[i]]++;
	}
	for(var i=0;i<this.map.length;i++){
		for(var j=0;j<this.map[i].length;j++){
			var tile=this.tile(i,j)();
			if(!tile) continue;
			var value=tile.value;
			if(timesLeft[value]) timesLeft[value]--;
		}
	}
	for(i in timesLeft) if(timesLeft[i]>0) return false;
	return true;
};
Game.prototype.toString=function(){
	return "256 Game | "+
	       "Move: "+(this.clickable?"Select where 2 should go":"Make a move")+" | "+
		   "Target(s): "+this.targetString()+" | "+
		   (this.won?"You won, good job!":this.over?"Game over;)":"Good luck!");
};

var startup=function(){
	var gamemap=[];
	var count=0;
	for(var i=0;i<games.length;i++){
		gamemap.push([]);
		for(var j=0;j<games.length;j++)
			gamemap[i].push(
				(!games[i][j])?
					null:
					(games[i][j]===CUSTOM)?
						new Tile(NaN):
						new Tile(count++)
				);
	}
	var game=new Game([-1e100,NaN,1e100],gamemap);
	hint.innerHTML="Hi there! Click something to begin your journey. Maybe... Start with 1?";
	window.hints=JSON.parse($("#hints").innerHTML);
	game.fake=true; //a fake game
	game.render(function(el){
		var pos=JSON.parse(el.getAttribute("coords"));
		var gameStr=games[pos[1]][pos[0]];
		var hintStr=hints[pos[1]][pos[0]];
		return function(){
			if(!gameStr) return;
			if(gameStr==CUSTOM){
				//TODO
				alert("TBD");
				return;
			}
			window.game=Game.fromString(gameStr);
			window.game.render();
			hint.innerHTML=hintStr;
		};
	});
	return game;
};

//load from storage
if(!localStorage[GAMEKEY]){
	if(!location.hash) var game=startup();
	else try{
		window.game=Game.fromString(location.hash.substr(1));
		game.render();
	}catch(e){
		alert("Unable to load from hash string: "+e);
		window.game=startup();
	}
}else{
	if(location.hash&&confirm("New game detected, do you wish to load it? Press Cancel if you are already playing.")){
		try{
			window.game=Game.fromString(location.hash.substr(1));
			game.render();
		}catch(e){
			alert("Unable to load from hash string: "+e);
			window.game=startup();
		}
	}else{
		var obj=JSON.parse(localStorage[GAMEKEY]);
		if(!obj.fake){
			for(var i=0;i<obj.map.length;i++){
				for(var j=0;j<obj.map[i].length;j++){
					if(obj.map[i][j]){
						obj.map[i][j]=new Tile(obj.map[i][j].value);
					}
				}
			}
			window.game=new Game(obj.targets,obj.map);
			if(obj.clickable!==undefined) game.clickable=obj.clickable;
			game.size=obj.size;
			game.won=obj.won;
			game.render();
		}else{
			window.game=startup();
		}
	}
}
</script>
<script>
//PWA
if('serviceWorker' in navigator) {
    navigator.serviceWorker.register('./sw.js');
};

</script>
</body>
</html>